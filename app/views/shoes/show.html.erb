<h1>Show page</h1>

<h2><%= @shoe.name %></h2>

<% if @shoe.photo.attached? %>
    <p><%= cl_image_tag @shoe.photo.key, crop: :scale, width: 500, cloud_name: "rafaelmellocloud" %></p>
<% end %>

<p><%= @shoe.description %></p>

<h4>AUD$ <%= @shoe.price.to_i %></h4>

<p><%= @shoe.categories_to_csv %></p>

<button type="button" id="checkout-button">Checkout</button>

<% if @shoe.user_id == current_user.id %>
  <p><%= link_to "Edit", edit_shoe_path(params[:id]) %></p>
  <p><%= link_to "Delete", @shoe, method: :delete, data: { confirm: "Are you sure?" } %>
<% end %>

<p><%= link_to "<< Back to menu", root_path %></p>

<script type="text/javascript">
  var stripe = Stripe("<%= ENV["STRIPE_PUBLISHABLE_KEY"] %>");
  var checkoutButton = document.getElementById("checkout-button");
  checkoutButton.addEventListener("click", function () {
    fetch("/shoes/<%= @shoe.id %>/checkout", {
      method: "POST",
    })
      .then(function (response) {
        return response.json();
      })
      .then(function (session) {
        return stripe.redirectToCheckout({ sessionId: session.id });
      })
      .then(function (result) {
        // If redirectToCheckout fails due to a browser or network
        // error, you should display the localized error message to your
        // customer using error.message.
        if (result.error) {
          alert(result.error.message);
        }
      })
      .catch(function (error) {
        console.error("Error:", error);
      });
  });
</script>